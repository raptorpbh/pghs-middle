<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teachable Machine → Game Character</title>

  <!-- 호환되는 TF.js 1.3.1 + Teachable Machine 0.8 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    :root { --ground: #6b8f4a; }
    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* 게임 배경 이미지 */
      background: url('https://cdn.pixabay.com/photo/2017/08/30/01/05/milky-way-2695569_1280.jpg') center/cover no-repeat;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    }
    header { padding: 12px; text-align: center; }
    h1 { margin: 0; font-size: 1.8rem; }
    p { margin: 8px 0 0; }

    #stage {
      position: relative;
      width: 900px;
      height: 360px;
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,.3);
      margin-top: 12px;
    }
    #ground {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 80px;
      background: var(--ground);
    }
    #character {
      position: absolute;
      left: 50%;
      bottom: 80px;
      width: 72px;
      height: 96px;
      margin-left: -36px;
      transition: left 0.12s linear, transform 0.24s ease;
      will-change: left, transform;
    }
    #character img { width: 100%; height: 100%; display: block; }

    #hud {
      display: flex;
      gap: 12px;
      padding: 12px;
      align-items: center;
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      margin: 8px;
    }
    #video {
      border-radius: 6px;
      transform: scaleX(-1);
      border: 2px solid #fff;
    }
    #controls { margin-left: auto; }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 0;
      background: #0b74de;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled { background: #555; cursor: not-allowed; }
    .status { font-weight: 600; color: #0f0; }

    footer {
      font-size: 13px;
      padding: 10px;
      color: #ddd;
      text-align: center;
    }

    @media (max-width: 980px) {
      #stage { width: 95%; }
      #hud { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Teachable Machine → Game Character</h1>
    <p>Model classes: <strong>left</strong>, <strong>right</strong>, <strong>stay</strong>, <strong>jump</strong></p>
  </header>

  <div id="hud">
    <div><video id="video" width="320" height="240" autoplay playsinline muted></video></div>
    <div id="controls">
      <button id="startBtn">Start webcam & model</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>
    <div style="margin-left:12px">
      <div>Predicted: <span class="status" id="pred">—</span></div>
      <div>Confidence: <span id="conf">—</span></div>
    </div>
  </div>

  <main style="padding:12px;display:flex;gap:12px;flex-direction:column;align-items:center;width:100%">
    <div id="stage" aria-label="game stage">
      <div id="character" aria-hidden="true">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='96'><rect rx='12' ry='12' width='72' height='96' fill='%23ffb86b'/><circle cx='36' cy='28' r='12' fill='%23fff'/><rect x='20' y='60' width='12' height='20' rx='4' ry='4' fill='%23666'/><rect x='40' y='60' width='12' height='20' rx='4' ry='4' fill='%23666'/></svg>" alt="game character"/>
      </div>
      <div id="ground"></div>
    </div>
    <div style="max-width:900px;text-align:center;color:#ccc;">
      Deploy on GitHub Pages: put this file (<code>index.html</code>) in your repository root and enable GitHub Pages (branch: main). Use <strong>HTTPS</strong>.
    </div>
  </main>

  <footer>Model URL: <code>https://teachablemachine.withgoogle.com/models/UGWuItBRh/</code></footer>

  <script>
    const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/UGWuItBRh/';
    const CLASS_LEFT = 'left', CLASS_RIGHT = 'right', CLASS_STAY = 'stay', CLASS_JUMP = 'jump';
    const SPEED = 6, SMOOTH_WINDOW = 7;

    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const predLabel = document.getElementById('pred');
    const confLabel = document.getElementById('conf');
    const character = document.getElementById('character');
    const stage = document.getElementById('stage');

    let model, stream, predictionHistory = [], running = false;
    let x = 0, vy = 0, onGround = true;
    character._y = 0;

    // 초기 위치 설정 (DOM 로드 후)
    function initPosition() {
      x = stage.clientWidth / 2 - 36;
      character.style.left = x + 'px';
    }

    async function loadModel() {
      if (!window.tmImage) throw new Error('tmImage undefined');
      const modelURL = MODEL_URL + 'model.json';
      const metadataURL = MODEL_URL + 'metadata.json';
      model = await tmImage.load(modelURL, metadataURL);
      console.log('Model loaded');
    }

    async function startWebcam() {
      stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
      video.srcObject = stream;
      await video.play();
    }

    function stopWebcam() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
      stream = null;
    }

    function mostFrequent(arr) {
      const counts = {};
      let best = null, bestCount = 0;
      for (const v of arr) {
        counts[v] = (counts[v] || 0) + 1;
        if (counts[v] > bestCount) { bestCount = counts[v]; best = v; }
      }
      return best;
    }

    function handleInput(action, confidence = 1) {
      if (confidence < 0.35) action = CLASS_STAY;

      if (action === CLASS_LEFT) x -= SPEED;
      if (action === CLASS_RIGHT) x += SPEED;
      if (action === CLASS_JUMP && onGround) { vy = -12; onGround = false; }
    }

    function updatePhysics() {
      vy += 0.6;
      character._y = Math.max(-220, character._y + vy);

      if (character._y > 0) {
        character._y = 0;
        vy = 0;
        onGround = true;
      }

      // 경계 제한
      x = Math.max(8, Math.min(stage.clientWidth - 80, x));
      character.style.left = x + 'px';
      character.style.transform = `translateY(${character._y}px)`;
    }

    async function predictLoop() {
      if (!running) return;

      const prediction = await model.predict(video);
      const top = prediction.reduce((a, b) => a.probability > b.probability ? a : b);

      predictionHistory.push(top.className);
      if (predictionHistory.length > SMOOTH_WINDOW) predictionHistory.shift();
      const smoothed = mostFrequent(predictionHistory);

      predLabel.textContent = smoothed || '—';
      confLabel.textContent = (top.probability * 100).toFixed(1) + '%';

      handleInput(smoothed, top.probability);
      updatePhysics();

      requestAnimationFrame(predictLoop);
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      predLabel.textContent = 'loading...';
      try {
        await loadModel();
        await startWebcam();
        initPosition();
        running = true;
        stopBtn.disabled = false;
        predictionHistory = [];
        predictLoop();
      } catch (err) {
        console.error(err);
        alert('Error: ' + err.message);
        startBtn.disabled = false;
      }
    });

    stopBtn.addEventListener('click', () => {
      running = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      predLabel.textContent = confLabel.textContent = '—';
      predictionHistory = [];
      stopWebcam();
    });

    window.addEventListener('resize', initPosition);
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft') handleInput(CLASS_LEFT);
      if (e.key === 'ArrowRight') handleInput(CLASS_RIGHT);
      if (e.key === ' ' || e.key === 'ArrowUp') handleInput(CLASS_JUMP);
      if (e.key === 'ArrowDown') handleInput(CLASS_STAY);
    });

    // DOM 로드 후 초기화
    window.addEventListener('load', initPosition);
  </script>
</body>
</html>
